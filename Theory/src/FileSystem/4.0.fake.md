

\begin{document}

\title{File Systems and Forensics Overview}
\author{}
\date{}
\maketitle

\section{Introduction}
Data storage in computers is organized hierarchically. At the top, there are fast and directly accessible storage devices (registers, cache) while slower, larger storage devices (hard drives, SSDs) reside at the bottom. This document focuses on secondary (external) memory storage, which has the following properties:
\begin{itemize}
    \item Not directly accessible by the CPU (data must be transferred to main memory before processing)
    \item Data is transferred in blocks rather than individual bytes
    \item Significantly slower than primary memory
    \item Non-volatile (retains data even when power is turned off)
\end{itemize}

Devices such as floppies, hard disks, CDs, DVDs, BDs, SD cards, SSDs, and pendrives are all considered block devices in the context of File System Forensic Analysis.

\subsection{Volumes and Partitions}
\textbf{\textcolor{blue}{Volume:}} A collection of addressable blocks. \\
\quad \textit{Notes:}
\begin{itemize}
    \item Blocks do not need to be contiguous on a physical device.
    \item A volume can be assembled by merging smaller volumes.
\end{itemize}

\textbf{\textcolor{blue}{Partition:}} A contiguous part of a volume. Partitioning is optional and some removable storage does not use it. By definition, both disks and partitions are volumes. In this course, we deal with block-device (forensics) images acquired from actual devices.

Users interact with files and directories rather than individual blocks. The \textcolor{blue}{file system} creates an abstraction layer by mapping files/directories to collections of blocks (usually clusters of sectors). Different file system formats exist (e.g., FAT, NTFS) and \textcolor{blue}{formatting} a volume initializes these on-disk data structures.

\section{VSFS (Very Simple File-System)}
In Unix-like file systems (e.g., EXT4, see \texttt{man mkfs.ext4}), every file or filesystem object has an associated \textcolor{blue}{inode} that stores metadata. Note that inodes do not store file names, which are kept in directory structures. Every file system object (regular file, directory, symbolic link, FIFO, socket, character device, block device) has an inode.

Formatting a file system involves preparing:
\begin{itemize}
    \item The superblock
    \item I-node and data bitmaps
    \item I-node table
    \item Data region
\end{itemize}

\begin{center}
    \includegraphics[width=0.7\linewidth]{./media/4.0.1.png}
\end{center}

\begin{wrapfigure}{r}{0.40\textwidth}
    \includegraphics[width=0.9\linewidth]{./media/4.0.2.png}
\end{wrapfigure}

An inode typically contains:
\begin{itemize}
    \item File type
    \item UID/GID/permission bits
    \item Time information
    \item Size in bytes
    \item Number of hard links (aliases)
    \item Pointers to data blocks
\end{itemize}

To access a file system stored on a \textbf{block device}, it must be \textcolor{blue}{mounted} (or parsed). Most modern operating systems automatically mount external storage devices when connected:
\begin{itemize}
    \item In Unix/Linux: a single root directory (\texttt{/}) with additional volumes mounted within the hierarchy.
    \item In Windows: each volume is assigned a drive letter (e.g., C:, D:, E:).
\end{itemize}

\begin{center}
    \includegraphics[width=0.7\linewidth]{./media/4.0.3.png}
\end{center}

Block devices are represented as “files” (e.g., Linux special files under \texttt{/dev}). For example:
\begin{itemize}
    \item Various aliases exist under \texttt{/dev/disk} (e.g., \texttt{/by-id}, \texttt{/by-uuid}, \texttt{/bypath}).
    \item The command \texttt{lsblk} lists information about available block devices.
\end{itemize}

Image files can be treated as block devices via the \texttt{losetup} command:
\begin{enumerate}
    \item Set up a loop device:
    \begin{lstlisting}[language=bash]
losetup -r -o $((1*512)) /dev/loop0 two-partitions.dd   # First partition
losetup -r -o $((1026*512)) /dev/loop1 two-partitions.dd  # Second partition
    \end{lstlisting}
    \item Verify with \texttt{fdisk -l} and mount:
    \begin{lstlisting}[language=bash]
mount -o ro /dev/loop0 /mnt/two-partition
mount -o ro /dev/loop1 /mnt/two-partition
    \end{lstlisting}
    \item \textbf{Second method:} Automatically create a loop device:
    \begin{lstlisting}[language=bash]
losetup -r --find --show --partscan two-partitions.dd

mount -o ro /dev/loop0p1 /mnt/part1
mount -o ro /dev/loop0p2 /mnt/part2

umount /dev/loop0p1
umount /dev/loop0p2
    \end{lstlisting}
\end{enumerate}

\section{The Sleuth Kit (TSK)}
The Sleuth Kit (TSK) is a forensic toolkit providing layers of analysis for digital investigations:
\begin{itemize}
    \item \texttt{img\_}: images
    \item \texttt{mm}: media-management (volumes)
    \item \texttt{fs}: file-system structures
    \item \texttt{j}: file-system journals
    \item \texttt{blk}: blocks/data-units
    \item \texttt{i}: inodes (file metadata)
    \item \texttt{f}: file names
\end{itemize}

These commands are typically followed by subcommands:
\begin{itemize}
    \item \texttt{stat} for general information
    \item \texttt{ls} for listing content
    \item \texttt{cat} for dumping/extracting content
\end{itemize}

\subsection{Example Commands}
\begin{lstlisting}[language=bash]
img_stat two-partitions.dd
img_cat two-partitions.dd

img_stat canon-sd-card.e01
\end{lstlisting}

File system data is categorized as:
\begin{itemize}
    \item \textbf{Essential Data:} Trustworthy and required for file retrieval.
    \item \textbf{Non-Essential Data:} Can be misleading and requires verification.
\end{itemize}

The Volume (or Media Management) layer in TSK focuses on disk partitions:
\begin{lstlisting}[language=bash]
mmstat image         # Displays partition scheme type
mmls image           # Displays partition layout
mmcat image part_num # Outputs the contents of a partition
\end{lstlisting}

\subsection{Volume Example}
\begin{lstlisting}[language=bash]
mmstat canon-sd-card.e01

mmls canon-sd-card.e01

##OUT##
DOS Partition Table
Offset Sector: 0
Units are in 512-byte sectors

      Slot      Start        End          Length       Description
000:  Meta      0000000000   0000000000   0000000001   Primary Table (#0)
001:  -------   0000000000   0000000050   0000000051   Unallocated
002:  000:000   0000000051   0000060799   0000060749   DOS FAT16 (0x04)
\end{lstlisting}

Then extract a partition:
\begin{lstlisting}[language=bash]
mmcat canon-sd-card.e01 2 > canon-sd-card.img
dd if=canon-sd-card.e01 of=canon-sd-card.dd bs=512 skip=51 

sha256sum canon-sd-card.img canon-sd-card.dd # ARE DIFFERENT!!!!!!!!
\end{lstlisting}

\section{DOS (or MBR) Partition Tables}
Introduced in 1983 with PC DOS 2.0, the MBR contains:
\begin{itemize}
    \item Machine code for the \textcolor{blue}{boot loader} (loads the active partition's Volume Boot Record)
    \item A 32-bit unique disk identifier (offset 440 / 0x1B8)
    \item Four 16-byte partition entries (starting at offset 446 / 0x1BE)
    \item MBR signature bytes (0x55 0xAA) at the end
\end{itemize}

\begin{center}
    \includegraphics[width=0.7\linewidth]{./media/4.0.4.png}
\end{center}

\subsection{MBR Layout}
\begin{lstlisting}[language=bash]
Offset (hex) | Size | Description
--------------------------------------------
0x000        | 446  | Bootstrap code area
0x1B8        | 4    | Disk signature
0x1BC        | 2    | Reserved (often 0x0000)
0x1BE        | 16   | Partition entry #1
0x1CE        | 16   | Partition entry #2
0x1DE        | 16   | Partition entry #3
0x1EE        | 16   | Partition entry #4
0x1FE        | 2    | MBR signature (0x55AA)
\end{lstlisting}

Each partition entry is structured as follows:
\begin{lstlisting}[language=bash]
Byte   | Description
---------------------------------------
0      | Boot indicator (0x80 = bootable, 0x00 = non-bootable)
1–3    | Starting CHS (often unused)
4      | Partition type (ID)
5–7    | Ending CHS
8–11   | Relative sectors (start in LBA)
12–15  | Total sectors in this partition
\end{lstlisting}

\subsection{Example: ImHex Analysis}
Use ImHex to extract disk and partition information from \texttt{mbr\{1,2,3\}.dd}. Then answer:
\begin{enumerate}
    \item What are the three disk signatures?
    \item Is there any MBR with inconsistent partitioning?
    \item Are there MBRs without bootable partitions?
    \item What is the largest FAT (id=4) partition?
    \item Is CHS information always present?
\end{enumerate}

Example commands:
\begin{lstlisting}[language=bash]
tar -tJf MBR123_and_GPT.tar.xz
tar -xJvf MBR123_and_GPT.tar.xz mbr1.dd

xxd -s 0x1B8 -l 4 mbr1.dd
\end{lstlisting}

\paragraph{Pattern Editor (ImHex):}
\begin{lstlisting}[language=c++]
#include <std/mem.pat>
struct PartitionEntry {
  u8  bootIndicator;
  u8  startCHS[3];
  u8  partitionType;
  u8  endCHS[3];
  u32 relativeSectors;
  u32 totalSectors;
};

struct MBR {
  u8 bootCode[0x1B8];         // 446 bytes
  u32 diskSignature;          // offset 0x1B8
  u16 reserved;               // offset 0x1BC (often 0x0000)
  PartitionEntry partitions[4];  // 4 partition entries, 16 bytes each
  u16 signature;              // offset 0x1FE, should be 0x55AA
};

MBR seg[while(!std::mem::eof())] @ 0x00;
\end{lstlisting}

\subsection{Extended Partitions}
Since MBR allows only 4 primary partitions, one slot can be designated as the \textcolor{blue}{primary extended partition} which contains further \textcolor{blue}{logical partitions}. Beware of logical-partition addressing, which is relative to the beginning of the extended partition rather than the whole disk.

\begin{center}
    \includegraphics[width=0.7\linewidth]{./media/4.0.6.png}
\end{center}

Within the primary extended partition:
\begin{itemize}
    \item A partition table (\textcolor{blue}{t}) describes the location of a logical partition (\textcolor{blue}{p}) relative to itself.
    \item It may also point to the next secondary extended partition.
\end{itemize}

\begin{center}
    \includegraphics[width=0.7\linewidth]{./media/4.0.7.png}
\end{center}

\subsubsection{Example: Extended Partitions Analysis}
Using \texttt{ext-partitions.dd} (SHA256: \texttt{b075ed83211...}), analyze with ImHex and compare with \texttt{fdisk/mmls} output.
\begin{lstlisting}[language=bash]
mmls ext-partitions.dd

      Slot      Start        End          Length       Description
000:  Meta      0000000000   0000000000   0000000001   Primary Table (#0)
001:  -------   0000000000   0000000062   0000000063   Unallocated
002:  000:000   0000000063   0000052415   0000052353   DOS FAT16 (0x04)
003:  000:001   0000052416   0000104831   0000052416   DOS FAT16 (0x04)
004:  000:002   0000104832   0000157247   0000052416   DOS FAT16 (0x04) 
005:  Meta      0000157248   0000312479   0000155232   DOS Extended (0x05)
006:  Meta      0000157248   0000157248   0000000001   Extended Table (#1)
007:  -------   0000157248   0000157310   0000000063   Unallocated
008:  001:000   0000157311   0000209663   0000052353   DOS FAT16 (0x04)
009:  -------   0000209664   0000209726   0000000063   Unallocated
010:  001:001   0000209727   0000262079   0000052353   DOS FAT16 (0x04)
011:  Meta      0000262080   0000312479   0000050400   DOS Extended (0x05)
012:  Meta      0000262080   0000262080   0000000001   Extended Table (#2)
013:  -------   0000262080   0000262142   0000000063   Unallocated
014:  002:000   0000262143   0000312479   0000050337   DOS FAT16 (0x06)
\end{lstlisting}

\section{GPT -- GUID Partition Tables}
GPT uses a 128-bit Universally Unique Identifier (UUID/GUID) in the format 8-4-4-4-12. Example:
\begin{lstlisting}[language=bash]
uuidgen
# bdeec955-b1b8-44a2-8034-15507d431aca
\end{lstlisting}

\begin{wrapfigure}{r}{0.40\textwidth}
    \includegraphics[width=0.9\linewidth]{./media/4.0.8.png}
\end{wrapfigure}

GPT is the current standard on PCs (used by EFI) and:
\begin{itemize}
    \item Starts with a protective MBR.
    \item Supports up to 128 partitions.
    \item Uses 64-bit LBA addresses.
    \item Maintains backup copies of important data structures.
\end{itemize}

\subsection{GPT Example}
Use ImHex to extract disk and partition information from \texttt{gpt.dd} and answer:
\begin{enumerate}
    \item What is the disk GUID?
    \item How many partitions are there?
    \item What are the partition names?
    \item Can you find the partition type GUIDs?
\end{enumerate}
Example commands:
\begin{lstlisting}[language=bash]
gdisk -l gpt.dd
mmls -t gpt gpt.dd
\end{lstlisting}

\section{File System Analysis}
File system analysis is based on a reference model covering various categories:
\begin{itemize}
    \item \textbf{File System Category:} Layout and size information (e.g., block size, total size).
    \item \textbf{Content:} Actual data stored in clusters/blocks.
    \item \textbf{MetaData:} Information describing files (size, creation date, etc.).
    \item \textbf{File Name:} Names assigned to files.
    \item \textbf{Application:} Additional data such as quota statistics or FS journals.
\end{itemize}

\begin{center}
    \includegraphics[width=0.5\linewidth]{./media/4.0.9.png}
\end{center}

To get general file system details, use:
\begin{lstlisting}[language=bash]
fsstat [-o sect_offs] image
\end{lstlisting}

\subsection{Example 1: OEM Name and Volume Label}
Find the OEM Name and Volume Label (Boot Sector) in \texttt{canon-sd-card.e01}:
\begin{lstlisting}[language=bash]
mmls canon-sd-card.e01

##OUT##
      Slot      Start        End          Length       Description
000:  Meta      0000000000   0000000000   0000000001   Primary Table (#0)
001:  -------   0000000000   0000000050   0000000051   Unallocated
002:  000:000   0000000051   0000060799   0000060749   DOS FAT16 (0x04)

fsstat -o 51 canon-sd-card.e01
\end{lstlisting}

\subsection{Example 2: Checking Partition Types}
Check whether the partition types in \texttt{two-partitions.dd} are correctly set:
\begin{lstlisting}[language=bash]
mmls two-partitions.dd

##OUT##
      Slot      Start        End          Length       Description
000:  Meta      0000000000   0000000000   0000000001   Primary Table (#0)
001:  -------   0000000000   0000000000   0000000001   Unallocated
002:  000:000   0000000001   0000001025   0000001025   DOS FAT16 (0x06) # wrong
003:  000:001   0000001026   0000002047   0000001022   DOS FAT12 (0x01)

fsstat -o 1 two-partitions.dd   # FAT12
fsstat -o 1026 two-partitions.dd # FAT12
\end{lstlisting}

\subsection{Example 3: String Search and Partition Mounting}
Inside the image file \texttt{two-partitions.dd}, search for strings:
\begin{lstlisting}[language=bash]
strings two-partitions.dd | grep -E "didattica|wDeek|tool|secret"
# or using ag:
strings two-partitions.dd | ag "didattica|wDeek|tool|secret"
\end{lstlisting}
Example output:
\begin{verbatim}
secret, wDeek, didattica
\end{verbatim}

Mount partitions to search within files:
\begin{lstlisting}[language=bash]
losetup -r --find --show --partscan two-partitions.dd

mount -o ro /dev/loop0p1 /mnt/part1
mount -o ro /dev/loop0p2 /mnt/part2

grep -rE "didattica|wDeek|tool|secret" /mnt/part1   # no output
grep -rE "didattica|wDeek|tool|secret" /mnt/part2   # finds "tool"
\end{lstlisting}
\vspace{0.5em}
Do some strings appear only in one search? What could be the reason? (Hint: slack space and data allocation differences.)

\section{Mapping File Data and Slack Space}
Each sector has multiple addresses:
\begin{itemize}
    \item Physical address (relative to storage media)
    \item Logical volume address
    \item File system (FS) address (logical cluster number)
    \item File address (virtual cluster number)
\end{itemize}

When writing a file smaller than the allocated cluster (e.g., a 612-byte file in a 2K cluster system), slack space is created. This unused space may contain remnants of previous data.

\begin{center}
    \includegraphics[width=0.9\linewidth]{./media/4.0.11.png}
\end{center}

Forensic analysts use two major approaches when investigating deleted files:
\begin{enumerate}
    \item \textbf{Metadata-based:} If metadata exists, the file’s size, timestamps, and allocated clusters can be recovered.
    \item \textbf{Application-based:} Data is recovered from unallocated space even when metadata is unavailable.
\end{enumerate}

\begin{center}
    \includegraphics[width=0.5\linewidth]{./media/4.0.12.png}
\end{center}

\section{TSK Metadata Commands}
TSK provides several commands for file system metadata analysis, especially focusing on inodes.

\begin{enumerate}
    \item \texttt{ils [-o sect\_offs] image} \\
    Lists inode information.
    \begin{itemize}
        \item \texttt{-r}: Lists only removed (deleted) files.
        \item \texttt{-a}: Lists only allocated (active) files.
        \item \texttt{-m}: Displays details in a mactime-compatible format.
    \end{itemize}
    \item \texttt{istat [-o sect\_offs] image inum} \\
    Dumps detailed metadata for a specific inode.
    \item \texttt{ifind [-n filename] [-d data-unit] [-o offset] image} \\
    Finds the inode corresponding to a data unit or file name.
    \item \texttt{ffind [-o sect\_offs] image inum} \\
    Lists file names using the inode.
    \item \texttt{icat [-o sect\_offs] image inum} \\
    Extracts/displays file content based on its inode.
    \begin{itemize}
        \item \texttt{-s}: Includes slack space.
        \item \texttt{-r}: Attempts to recover deleted files.
    \end{itemize}
    \item Additional commands:
    \begin{itemize}
        \item \texttt{blkstat image block}: Displays metadata for a specific block.
        \item \texttt{blkcat image block [how-many-blocks]}: Outputs raw block content.
        \item \texttt{blkls}: Lists or outputs blocks.
        \item \texttt{fls [-o sect\_offs] image [inum]}: Lists files in a directory corresponding to an inode.
    \end{itemize}
\end{enumerate}

\subsection{Example: Analyzing Partition Data}
Below is an example that demonstrates why certain strings appear in one search and not another.

\begin{lstlisting}[language=bash]
mmls two-partitions.dd

##OUT##
      Slot      Start        End          Length       Description
000:  Meta      0000000000   0000000000   0000000001   Primary Table (#0)
001:  -------   0000000000   0000000000   0000000001   Unallocated
002:  000:000   0000000001   0000001025   0000001025   DOS FAT16 (0x06)
003:  000:001   0000001026   0000002047   0000001022   DOS FAT12 (0x01)

strings -t d two-partitions.dd | grep -E "didattica|wDeek|tool|secret"

##OUT##
 20514 and I have a secret message ;)
 547396 wDeek
 547436 /home/gio/didattica/file-systems/vol_fs_analysis/examples/pp/test
\end{lstlisting}

\textbf{Analysis:}
\begin{itemize}
    \item End of first partition: $(1025 \times 512) = 524800$ \quad $\Rightarrow$ "secret" is in the first partition.
    \item Start of second partition: $(1025 \times 512) = 525312$ \quad $\Rightarrow$ "wDeek" is in the second partition.
    \item End of second partition: $(1025 \times 512) = 1048064$ \quad $\Rightarrow$ "didattica" is in the second partition.
\end{itemize}

\subsubsection{Finding "secret"}
\begin{lstlisting}[language=bash]
# Calculate sector number and offset:
# "secret" is at sector: 20514/512 = 40 (beginning of disk, but partition starts at sector 1)
# Offset = 40 - 1 = 39

ifind -d 39 -o 1 two-partitions.dd  # Returns inode 4 for block 39 of partition starting at 1

istat -o 1 two-partitions.dd 4

##OUT##
Directory Entry: 4
Allocated
File Attributes: File, Archive
Size: 34
Name: HELLO.TXT

Directory Entry Times:
 Written: 2023-03-16 08:57:32 (EDT)
 Accessed: 2023-03-16 00:00:00 (EDT)
 Created: 2023-03-16 08:57:32 (EDT)

Sectors:
 39 0 0 0  # Using only one sector

icat -s -o 1 two-partitions.dd 4

##OUT##
Hi there! ...
\end{lstlisting}

\subsubsection{Finding "wDeek"}
\begin{lstlisting}[language=bash]
# "wDeek" is at sector: 547396/512 = 1069 (partition starts at sector 1026)
# Offset = 1069 - 1026 = 43

ifind -d 43 -o 1026 two-partitions.dd  # Returns inode 6 for block 43 in partition starting at 1026

istat -o 1026 two-partitions.dd 6

##OUT##
Directory Entry: 6
Not Allocated  # DELETED (not mounted by OS)
File Attributes: File, Archive
Size: 4096
Name: _EST~1.SWP

Directory Entry Times:
 Written: 2023-03-16 09:04:10 (EDT)
 Accessed: 2023-03-16 00:00:00 (EDT)
 Created: 2023-03-16 09:04:10 (EDT)

Sectors:
 43 44 45 46 47 48 49 50

icat -o 1026 two-partitions.dd 6 | strings

##OUT##
b0VIM 8.2
root
wDeek
/home/gio/didattica/file-systems/vol_fs_analysis/examples/pp/test
3210
#"!
\end{lstlisting}

\section*{Conclusion}
This document has covered the organization of file systems, disk partitioning schemes (MBR and GPT), forensic analysis using TSK, and the investigation of deleted files. The examples and commands provided give an overview of the techniques used to analyze and extract information from block devices and file system images.

\end{document}
